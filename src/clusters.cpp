// Module for X-ray cluster fgas data
// (c) 2013, 2020  Adam Mantz, amantz@stanford.edu

#include "clusters.hpp"

#include <fstream>

using std::atan;
using std::log;
using std::pow;
using std::sqrt;

namespace Clusters {

  double NFWmodel::f_inverse(const double f) {
    const double a1 = 0.5116;
    const double a2 = -0.4283;
    const double a3 = -3.13e-3;
    const double a4 = -3.52e-5;
    double logf, p;
    logf = log(f);
    p = a2 + a3*logf + a4*logf*logf;
    return 1.0/sqrt( a1*pow(f, 2.0*p) + 0.5625) + 2.0*f;
  }

  double NFWmodel::unn_shear(const double x) {
    double x2, a, b, b2, b3, c;
    x2 = pow2(x);
    if (x < 1.0) {
      a = atanh(sqrt((1-x)/(1+x)));
      b = sqrt(1-x2);
      c = x2 - 1;
      return 8*a/(b*x2) + 4*log(x/2)/x2 - 2/c + 4*a/(b*c);
    } 
    else if (x > 1.0) {
      a = atan(sqrt((x-1)/(1+x)));
      b = sqrt(x2-1);
      b2 = pow2(b);
      b3 = b*b2;
      return 8*a/(b*x2) + 4*log(x/2)/x2 - 2/b2 + 4*a/b3;
    }
    // x == 1
    return 10.0/3.0 + 4.0*log(0.5);
  }

  double NFWmodel::unn_kappa(const double x) {
    double x2, a, b, b2, b3, c;
    x2 = pow2(x);
    if (x < 1.0) {
      a = atanh(sqrt((1-x)/(1+x)));
      b = sqrt(1-x2);
      c = 1./(x2 - 1);
      return c*(1 - 2.*a/b);
    } 
    else if (x > 1.0) {
      a = atan(sqrt((x-1)/(1+x)));
      b = sqrt(x2-1);
      c = 1./(x2 - 1);
      return c*(1 - 2.*a/b);
    } 
    // x == 1
    return 1./3.;
  }


  double ClusterModel::mHe_mp = 6.64465620e-24/1.67262158e-24; // ratio of alpha mass to proton mass
  
  bool ClusterModel::init(func2 &f, const string& filename) {
    AngularDiameterDistance = f;
    // default values
    U_baryon_0 = 0.824;
    U_baryon_1 = 0.0;
    U_coldgas_0 = 0.010;
    U_coldgas_1 = 0.0;
    fgas_scatter = 0.08;
    massScaling = 0.0;
    massPivot = 3.0e14;
    fb_cosmic = 0.16;
    set_from_YHe(0.24);
    return true;
  }

  bool ClusterModel::load_parameters(const double fb0, const double fb1, const double fc0, const double fc1, const double scat, const double rslope, const double Mslope, const double Mscaling, const double fbcos, const double YHe, const double nenh, const double ntne, const double myoo) {
    U_baryon_0 = fb0;
    U_baryon_1 = fb1;
    U_coldgas_0 = fc0;
    U_coldgas_1 = fc1;
    fgas_scatter = scat;
    fb_prof.index = rslope;
    mtot_prof.index = Mslope;
    massScaling = Mscaling;
    fb_cosmic = fbcos;
    if (YHe >= 0.0) set_from_YHe(YHe);
    else {
      ne_nH = nenh;
      ntot_ne = ntne;
      mu = myoo;
    }
    if (ne_nH < 0.0 || ntot_ne < 0.0 || mu < 0.0) return false;
    return true;
  }

  void ClusterModel::set_from_YHe(const double YHe) {
    // YHe is the primordial mass fraction of He (assume no other species apart from H)
    double nHe_nH = YHe / ((1.0 - YHe) * mHe_mp); // He/H number density
    ne_nH = 1.0 + 2.0 * nHe_nH; // electron/H number
    ntot_ne = 1.0 + (1.0+nHe_nH) / ne_nH; // (electron+baryon)/electron number
    mu = (1.0/ne_nH + mHe_mp*nHe_nH/ne_nH) / ntot_ne; // mean particle mass in units of mp
  }

  NuisanceParameters::NuisanceParameters() : do_lensing_calibration(true), nonthermal(1.0), calibration(1.0), calibration_evol(0.0), calibration_scatter(0.17), lensing_systematics(1.0), lensing_systematics_evol(0.0) {
    const size_t num_concentrations = 1000;
    // first num_concentrations Sobol quasi-random numbers (1 dimension) translated to the standard normal distribution
    // NB the compiler MAY NOT enforce that the size is correct here, so be careful if changing it later
    const double qrnd_unorm[num_concentrations] = { 0.0, 0.674489750196082, -0.674489750196082, -0.318639363964375, 1.15034938037601, 0.318639363964375, -1.15034938037601, -0.887146559018876, 0.488776411114669, 1.53412054435255, -0.157310684610171, -0.488776411114669, 0.887146559018876, 0.157310684610171, -1.53412054435255, -1.31801089730354, 0.237202109328788, 1.00999016924958, -0.402250065321725, -0.0784124127331122, 1.86273186742165, 0.579132162255556, -0.776421761147928, -1.00999016924958, 0.402250065321725, 1.31801089730354, -0.237202109328788, -0.579132162255556, 0.776421761147928, 0.0784124127331122, -1.86273186742165, -1.67593972277344, 0.117769874579095, 0.830510878205399, -0.53340970624128, -0.197099084294312, 1.41779713799627, 0.445096524985516, -0.946781756301046, -0.724514383492365, 0.626099012346421, 2.15387469406146, -0.0391760855030976, -0.360129891789569, 1.07751556704028, 0.277690439821577, -1.22985875921659, -1.41779713799627, 0.197099084294312, 0.946781756301046, -0.445096524985516, -0.117769874579095, 1.67593972277344, 0.53340970624128, -0.830510878205399, -1.07751556704028, 0.360129891789569, 1.22985875921659, -0.277690439821577, -0.626099012346421, 0.724514383492365, 0.0391760855030976, -2.15387469406146, -1.9874278859299, 0.0587829360689431, 0.75021537546794, -0.602449453164424, -0.257393526100938, 1.27269864119054, 0.381105454763556, -1.04315826331845, -0.803172565597918, 0.556125593618691, 1.76167041036307, -0.0980721524886611, -0.4235760842012, 0.977897543940542, 0.21710694721013, -1.3662038163721, -1.18916435019934, 0.298102412930487, 1.11319427716093, -0.339311606538817, -0.0195842852301269, 2.4175590162365, 0.650104070647995, -0.69928330238322, -0.916556667533112, 0.46682512285259, 1.4734675779471, -0.17716982099174, -0.510965806738247, 0.858484474141832, 0.137513402144336, -1.60100866488608, -1.76167041036307, 0.0980721524886611, 0.803172565597918, -0.556125593618691, -0.21710694721013, 1.3662038163721, 0.4235760842012, -0.977897543940542, -0.75021537546794, 0.602449453164424, 1.9874278859299, -0.0587829360689431, -0.381105454763556, 1.04315826331845, 0.257393526100938, -1.27269864119054, -1.4734675779471, 0.17716982099174, 0.916556667533112, -0.46682512285259, -0.137513402144336, 1.60100866488608, 0.510965806738247, -0.858484474141832, -1.11319427716093, 0.339311606538817, 1.18916435019934, -0.298102412930487, -0.650104070647995, 0.69928330238322, 0.0195842852301269, -2.4175590162365, -2.26622680920965, 0.029378775744157, 0.711842195939419, -0.638055580922517, -0.287881432831012, 1.20926123170915, 0.349701803553895, -1.09518065276139, -0.844415077375257, 0.522154877598001, 1.63732538276806, -0.12763541906627, -0.455933915613139, 0.931562830007115, 0.187125162225721, -1.44507257981807, -1.25099171546255, 0.267528206101097, 1.06018047943536, -0.370597291109629, -0.0489771572021319, 2.06352789831624, 0.614231289060245, -0.737304000438654, -0.962223195295421, 0.43431116117521, 1.3915374879959, -0.20709265272436, -0.544732512988176, 0.816765415315091, 0.107915779489187, -1.71722811750574, -1.56668858606841, 0.147404821612355, 0.87272589462704, -0.499840344883735, -0.16723200837085, 1.50310294312927, 0.477771988903886, -0.9017541138301, -0.686833748574731, 0.662247682488414, 2.66006746861746, -0.00979167316134535, -0.328957912640491, 1.13157655838619, 0.308354631344837, -1.16953661020714, -1.34171784108025, 0.227143062502715, 0.993815907860883, -0.412889601443654, -0.0882380194499245, 1.80989223848061, 0.567591323544569, -0.789726519943266, -1.02643306313791, 0.391655871092591, 1.29502240670581, -0.247285215340805, -0.590750658062819, 0.76325304373257, 0.0685943705051181, -1.9213507742937, -2.06352789831624, 0.0489771572021319, 0.737304000438654, -0.614231289060245, -0.267528206101097, 1.25099171546255, 0.370597291109629, -1.06018047943536, -0.816765415315091, 0.544732512988176, 1.71722811750574, -0.107915779489187, -0.43431116117521, 0.962223195295421, 0.20709265272436, -1.3915374879959, -1.20926123170915, 0.287881432831012, 1.09518065276139, -0.349701803553895, -0.029378775744157, 2.26622680920965, 0.638055580922517, -0.711842195939419, -0.931562830007115, 0.455933915613139, 1.44507257981807, -0.187125162225721, -0.522154877598001, 0.844415077375257, 0.12763541906627, -1.63732538276806, -1.80989223848061, 0.0882380194499245, 0.789726519943266, -0.567591323544569, -0.227143062502715, 1.34171784108025, 0.412889601443654, -0.993815907860883, -0.76325304373257, 0.590750658062819, 1.9213507742937, -0.0685943705051181, -0.391655871092591, 1.02643306313791, 0.247285215340805, -1.29502240670581, -1.50310294312927, 0.16723200837085, 0.9017541138301, -0.477771988903886, -0.147404821612355, 1.56668858606841, 0.499840344883735, -0.87272589462704, -1.13157655838619, 0.328957912640491, 1.16953661020714, -0.308354631344837, -0.662247682488414, 0.686833748574731, 0.00979167316134535, -2.66006746861746, -2.52050221719036, 0.0146878031333598, 0.693045098387663, -0.656163781150379, -0.303224538198166, 1.17929369001065, 0.33413028225882, -1.12233801170217, -0.865583239756308, 0.505395256291619, 1.58361547580179, -0.142457369611016, -0.472291481268261, 0.909130489944847, 0.172198788871808, -1.48812189602338, -1.28378055260817, 0.25233614780249, 1.03475948108824, -0.3863752869032, -0.0636878869241329, 1.95332370774539, 0.596589849251445, -0.756718131051078, -0.985825500405061, 0.418226872548409, 1.35385936407511, -0.222122208220557, -0.561849225726257, 0.796431543684233, 0.0931539598455833, -1.78526249043532, -1.61890014353736, 0.132572793629228, 0.851428708305571, -0.516552258376321, -0.182145235070168, 1.45912302502159, 0.461372678278513, -0.924033738805388, -0.705548838662176, 0.644068138600693, 2.33523304006881, -0.0244812369184941, -0.34450205612612, 1.10414267929223, 0.292988096856233, -1.19915225099327, -1.37876004322192, 0.212097141151849, 0.970030579177241, -0.428937443704609, -0.102992718520838, 1.7390199717299, 0.550420122521827, -0.809950283969892, -1.05163128165734, 0.375846185216561, 1.26177086163599, -0.262457496397155, -0.608329815634632, 0.743744189746654, 0.0538793990464063, -2.02401362371916, -1.89122923782011, 0.0735025059641587, 0.769820715012041, -0.584931540146927, -0.242240583770448, 1.30643035112756, 0.396947399151455, -1.01817720560067, -0.783056813674774, 0.573352197171953, 1.83567153691254, -0.0833242105440363, -0.40756406632868, 1.00187027637698, 0.232169649403845, -1.32977095018121, -1.15988961852528, 0.313492852637276, 1.14091270934231, -0.323794328878954, -0.00489577790634245, 2.88563491242676, 0.668356195590579, -0.680648785127646, -0.894426479612224, 0.483266884672673, 1.51842914115259, -0.16226934990287, -0.494300814491471, 0.879913353819681, 0.152355884338473, -1.55019904079176, -1.69622250500661, 0.112841457367714, 0.823618695051533, -0.539062470681719, -0.202093345575596, 1.40454624815887, 0.43969744961512, -0.954474027767443, -0.730894247427629, 0.620154232595207, 2.10655408816281, -0.0440760921002205, -0.365358587538023, 1.0688078752592, 0.2726058039057, -1.24035599423067, -1.43130175910248, 0.19210973438208, 0.939145102896062, -0.450508606282178, -0.122701154016606, 1.65632386534081, 0.52777393514818, -0.837442740149245, -1.0863057362981, 0.354911023290717, 1.21949532284622, -0.282782265212403, -0.632066001577947, 0.718163873887231, 0.0342770193514366, -2.20657521653713, -2.33523304006881, 0.0244812369184941, 0.705548838662176, -0.644068138600693, -0.292988096856233, 1.19915225099327, 0.34450205612612, -1.10414267929223, -0.851428708305571, 0.516552258376321, 1.61890014353736, -0.132572793629228, -0.461372678278513, 0.924033738805388, 0.182145235070168, -1.45912302502159, -1.26177086163599, 0.262457496397155, 1.05163128165734, -0.375846185216561, -0.0538793990464063, 2.02401362371916, 0.608329815634632, -0.743744189746654, -0.970030579177241, 0.428937443704609, 1.37876004322192, -0.212097141151849, -0.550420122521827, 0.809950283969892, 0.102992718520838, -1.7390199717299, -1.58361547580179, 0.142457369611016, 0.865583239756308, -0.505395256291619, -0.172198788871808, 1.48812189602338, 0.472291481268261, -0.909130489944847, -0.693045098387663, 0.656163781150379, 2.52050221719036, -0.0146878031333598, -0.33413028225882, 1.12233801170217, 0.303224538198166, -1.17929369001065, -1.35385936407511, 0.222122208220557, 0.985825500405061, -0.418226872548409, -0.0931539598455833, 1.78526249043532, 0.561849225726257, -0.796431543684233, -1.03475948108824, 0.3863752869032, 1.28378055260817, -0.25233614780249, -0.596589849251445, 0.756718131051078, 0.0636878869241329, -1.95332370774539, -2.10655408816281, 0.0440760921002205, 0.730894247427629, -0.620154232595207, -0.2726058039057, 1.24035599423067, 0.365358587538023, -1.0688078752592, -0.823618695051533, 0.539062470681719, 1.69622250500661, -0.112841457367714, -0.43969744961512, 0.954474027767443, 0.202093345575596, -1.40454624815887, -1.21949532284622, 0.282782265212403, 1.0863057362981, -0.354911023290717, -0.0342770193514366, 2.20657521653713, 0.632066001577947, -0.718163873887231, -0.939145102896062, 0.450508606282178, 1.43130175910248, -0.19210973438208, -0.52777393514818, 0.837442740149245, 0.122701154016606, -1.65632386534081, -1.83567153691254, 0.0833242105440363, 0.783056813674774, -0.573352197171953, -0.232169649403845, 1.32977095018121, 0.40756406632868, -1.00187027637698, -0.769820715012041, 0.584931540146927, 1.89122923782011, -0.0735025059641587, -0.396947399151455, 1.01817720560067, 0.242240583770448, -1.30643035112756, -1.51842914115259, 0.16226934990287, 0.894426479612224, -0.483266884672673, -0.152355884338473, 1.55019904079176, 0.494300814491471, -0.879913353819681, -1.14091270934231, 0.323794328878954, 1.15988961852528, -0.313492852637276, -0.668356195590579, 0.680648785127646, 0.00489577790634245, -2.88563491242676, -2.75554887345342, 0.00734370353043169, 0.683737997401054, -0.665298835919928, -0.310922715893284, 1.16469956534333, 0.326375033007281, -1.13623225407686, -0.876313965464153, 0.497068673028721, 1.55839084718429, -0.149879893723577, -0.480517623198981, 0.898084268969658, 0.16475017195312, -1.5107216853605, -1.3007052195221, 0.244762120956717, 1.02229642449682, -0.394300255055697, -0.0710482242921843, 1.90607384923176, 0.587838610917144, -0.76653274638327, -0.997835000557589, 0.410225379567002, 1.33572056504665, -0.229655630625748, -0.570469393786029, 0.786387293998826, 0.0857808560936914, -1.82263048663553, -1.64675032766897, 0.125167905608435, 0.840923798724339, -0.524962334487275, -0.189616859401405, 1.43815307900302, 0.453219593437879, -0.935347244701583, -0.714999463162297, 0.635057943402778, 2.23540724355632, -0.0318278020929306, -0.352305218402456, 1.09073245569302, 0.285330921640916, -1.21436237874935, -1.39801229534686, 0.204592359975061, 0.958341418018926, -0.437002720596656, -0.110378283674032, 1.70663118536312, 0.541895314131648, -0.820187239913321, -1.06448427337982, 0.367976676977171, 1.24565624149491, -0.270066134646447, -0.617190054347694, 0.734095353894574, 0.0465264849526418, -2.08455871840791, -1.9370897365465, 0.0661409296831973, 0.759981530500801, -0.593667723429761, -0.249809884929244, 1.2893811107918, 0.389014223059009, -1.03058734087267, -0.793074574990729, 0.564717947168687, 1.79744107394942, -0.0906957156729311, -0.415556757275935, 0.989812804597863, 0.224631927517902, -1.3477637672852, -1.17440117463922, 0.305788578807489, 1.12694526183216, -0.331542988709853, -0.0122397014708965, 2.58401958059948, 0.659202681860284, -0.689936096184168, -0.905436143675761, 0.475029951585417, 1.49557046317418, -0.169714875285445, -0.502615861929802, 0.869149024454586, 0.144930652172474, -1.57509561962568, -1.72802147121901, 0.105453929524875, 0.813353127508359, -0.547574103573779, -0.209594240778642, 1.38512049830698, 0.431622744449859, -0.966119525969419, -0.740520255855527, 0.611277891191507, 2.04337202094265, -0.0514281236341141, -0.373220452841663, 1.05589623376374, 0.264991999560325, -1.2563630414547, -1.45206197024557, 0.184634626287249, 0.927791710155385, -0.458651601070847, -0.130103709894028, 1.62804367632253, 0.519351530221023, -0.847916679096402, -1.09965062580976, 0.347100756751592, 1.20419135908412, -0.290433818099894, -0.641058962903565, 0.708692008707423, 0.0269299255889371, -2.29936229740323, -2.17946859778912, 0.0367264422438769, 0.72133549234393, -0.629079707162832, -0.280235444318555, 1.22466059983832, 0.357519240337698, -1.08190020225002, -0.833971800052114, 0.530589714123105, 1.66605166238845, -0.120235148819768, -0.44780092608518, 0.942956555614785, 0.194603803788316, -1.42451697418177, -1.23509036459975, 0.275147232671631, 1.07315154982209, -0.36274300002125, -0.0416259638712113, 2.12961846911981, 0.623123869784967, -0.727700613034726, -0.950620860870747, 0.442395375318794, 1.41114072110521, -0.19959559262874, -0.536233946622638, 0.827059875726257, 0.115305315887256, -1.68599441546561, -1.5421099601365, 0.154832809329535, 0.883524178244099, -0.49153673764685, -0.15978952613545, 1.52622786964839, 0.486019803756523, -0.890780618191639, -0.677566054832191, 0.671419815495155, 3.09726907819878, -0.00244788161911068, -0.321215779435019, 1.14561829257781, 0.316065061863936, -1.15510635777657, -1.32386803759834, 0.234685136420896, 1.00592193241354, -0.404905636576578, -0.0808680677627817, 1.84903246516889, 0.57623977333281, -0.779734996530243, -1.01407519104019, 0.399597327736265, 1.31219862702896, -0.239720585848375, -0.58202940428861, 0.773117027116272, 0.075957230458921, -1.8767900479811, -2.0053852719249, 0.0563309982498503, 0.746975872532823, -0.605387017711062, -0.259924678065871, 1.26721583563447, 0.378474511416355, -1.04738537323502, -0.806556793379432, 0.553270606780821, 1.75023295183998, -0.100532131244173, -0.426255232406073, 0.973956526882356, 0.21460137091761, -1.37245488241084, -1.19414340989772, 0.295544288601364, 1.10865712398397, -0.341905679930527, -0.0220326950308341, 2.37438680605393, 0.647083157764331, -0.702412623695317, -0.920288771883032, 0.464097175910881, 1.46625758841323, -0.17965697210979, -0.513757028359516, 0.854951270871459, 0.135042685843707, -1.60988998841876, -1.77334307781058, 0.09561276707409, 0.7997975116462, -0.558985120627175, -0.21961388722509, 1.36000568463741, 0.420899972915016, -0.981853808166937, -0.753462770653122, 0.599517078154522, 1.97008940475787, -0.0612352273424688, -0.383739038722914, 1.0389497113123, 0.254864022115934, -1.27821997483642, -1.4807549883929, 0.174683765351141, 0.912837286072549, -0.469556548200866, -0.139984958173739, 1.59225185952329, 0.508178560348605, -0.862028426972385, -1.11775446278603, 0.336719814444443, 1.18421459785573, -0.300662489533887, -0.653130928015844, 0.696160813976152, 0.0171359928260878, -2.4657708956965, -2.58401958059948, 0.0122397014708965, 0.689936096184168, -0.659202681860284, -0.305788578807489, 1.17440117463922, 0.331542988709853, -1.12694526183216, -0.869149024454586, 0.502615861929802, 1.57509561962568, -0.144930652172474, -0.475029951585417, 0.905436143675761, 0.169714875285445, -1.49557046317418, -1.2893811107918, 0.249809884929244, 1.03058734087267, -0.389014223059009, -0.0661409296831973, 1.9370897365465, 0.593667723429761, -0.759981530500801, -0.989812804597863, 0.415556757275935, 1.3477637672852, -0.224631927517902, -0.564717947168687, 0.793074574990729, 0.0906957156729311, -1.79744107394942, -1.62804367632253, 0.130103709894028, 0.847916679096402, -0.519351530221023, -0.184634626287249, 1.45206197024557, 0.458651601070847, -0.927791710155385, -0.708692008707423, 0.641058962903565, 2.29936229740323, -0.0269299255889371, -0.347100756751592, 1.09965062580976, 0.290433818099894, -1.20419135908412, -1.38512049830698, 0.209594240778642, 0.966119525969419, -0.431622744449859, -0.105453929524875, 1.72802147121901, 0.547574103573779, -0.813353127508359, -1.05589623376374, 0.373220452841663, 1.2563630414547, -0.264991999560325, -0.611277891191507, 0.740520255855527, 0.0514281236341141, -2.04337202094265, -1.90607384923176, 0.0710482242921843, 0.76653274638327, -0.587838610917144, -0.244762120956717, 1.3007052195221, 0.394300255055697, -1.02229642449682, -0.786387293998826, 0.570469393786029, 1.82263048663553, -0.0857808560936914, -0.410225379567002, 0.997835000557589, 0.229655630625748, -1.33572056504665, -1.16469956534333, 0.310922715893284, 1.13623225407686, -0.326375033007281, -0.00734370353043169, 2.75554887345342, 0.665298835919928, -0.683737997401054, -0.898084268969658, 0.480517623198981, 1.5107216853605, -0.16475017195312, -0.497068673028721, 0.876313965464153, 0.149879893723577, -1.55839084718429, -1.70663118536312, 0.110378283674032, 0.820187239913321, -0.541895314131648, -0.204592359975061, 1.39801229534686, 0.437002720596656, -0.958341418018926, -0.734095353894574, 0.617190054347694, 2.08455871840791, -0.0465264849526418, -0.367976676977171, 1.06448427337982, 0.270066134646447, -1.24565624149491, -1.43815307900302, 0.189616859401405, 0.935347244701583, -0.453219593437879, -0.125167905608435, 1.64675032766897, 0.524962334487275, -0.840923798724339, -1.09073245569302, 0.352305218402456, 1.21436237874935, -0.285330921640916, -0.635057943402778, 0.714999463162297, 0.0318278020929306, -2.23540724355632, -2.37438680605393, 0.0220326950308341, 0.702412623695317, -0.647083157764331, -0.295544288601364, 1.19414340989772, 0.341905679930527, -1.10865712398397, -0.854951270871459, 0.513757028359516, 1.60988998841876, -0.135042685843707, -0.464097175910881, 0.920288771883032, 0.17965697210979, -1.46625758841323, -1.26721583563447, 0.259924678065871, 1.04738537323502, -0.378474511416355, -0.0563309982498503, 2.0053852719249, 0.605387017711062, -0.746975872532823, -0.973956526882356, 0.426255232406073, 1.37245488241084, -0.21460137091761, -0.553270606780821, 0.806556793379432, 0.100532131244173, -1.75023295183998, -1.59225185952329, 0.139984958173739, 0.862028426972385, -0.508178560348605, -0.174683765351141, 1.4807549883929, 0.469556548200866, -0.912837286072549, -0.696160813976152, 0.653130928015844, 2.4657708956965, -0.0171359928260878, -0.336719814444443, 1.11775446278603, 0.300662489533887, -1.18421459785573, -1.36000568463741, 0.21961388722509, 0.981853808166937, -0.420899972915016, -0.09561276707409, 1.77334307781058, 0.558985120627175, -0.7997975116462, -1.0389497113123, 0.383739038722914, 1.27821997483642, -0.254864022115934, -0.599517078154522, 0.753462770653122, 0.0612352273424688, -1.97008940475787, -2.12961846911981, 0.0416259638712113, 0.727700613034726, -0.623123869784967, -0.275147232671631, 1.23509036459975, 0.36274300002125, -1.07315154982209, -0.827059875726257, 0.536233946622638, 1.68599441546561, -0.115305315887256, -0.442395375318794, 0.950620860870747, 0.19959559262874, -1.41114072110521, -1.22466059983832, 0.280235444318555, 1.08190020225002, -0.357519240337698, -0.0367264422438769, 2.17946859778912, 0.629079707162832, -0.72133549234393, -0.942956555614785, 0.44780092608518, 1.42451697418177, -0.194603803788316, -0.530589714123105, 0.833971800052114, 0.120235148819768, -1.66605166238845, -1.84903246516889, 0.0808680677627817, 0.779734996530243, -0.57623977333281, -0.234685136420896, 1.32386803759834, 0.404905636576578, -1.00592193241354, -0.773117027116272 };
    lensing_concentrations.resize(num_concentrations);
    lensing_concentrations500.resize(num_concentrations);
    for (int i=0; i<lensing_concentrations.size(); ++i) {
      lensing_concentrations[i] = exp( log(10.0)*(0.664 + 0.061*qrnd_unorm[i]) ); // Neto prior
      lensing_concentrations500[i] = 1.0 / NFWmodel::f_inverse( 500.0/200.0 * NFWmodel::f_fcn(1.0/lensing_concentrations[i]) ); // might as well convert to 500 once and be done with it
    }
  }

}

std::istream& operator>>(std::istream &is, Clusters::NFWmodel &m) {
  return is >> m.nfwa >> m.nfwpot;
}

std::ostream& operator<<(std::ostream &os, Clusters::NFWmodel &m) {
  return os << m.nfwa <<' '<< m.nfwpot;
}

std::ostream& operator<<(std::ostream &os, Clusters::NuisanceParameters &n) {
  return os << "nonthermal: " <<  n.nonthermal << '\n' <<
    "calibration: " <<  n.calibration << '\n' <<
    "calibration_evol: " <<  n.calibration_evol << '\n' <<
    "calibration_scatter: " <<  n.calibration_scatter << '\n' <<
    "lensing_systematics: " <<  n.lensing_systematics << '\n' <<
    "lensing_systematics_evol: " <<  n.lensing_systematics_evol << '\n';
}
